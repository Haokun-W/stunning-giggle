
# 党建系统现状

党建系统是由数科公司完全自主开发，用于开展党建工作的平台。作为数科公司主推的市场化产品，目前杭州已有20余家省属国企、央企等，并且正在努力往市属企业做推广。

系统包含组织建设、队伍建设、组织生活、党费管理、组织考核等规范动作、标准动作外，同时系统支持通过服务发布、接口登记模式快速适配第三方应用。同时，党建系统还和国资委监管系统，红色根脉强基系统，中心组学习系统等第三方系统做了数据对接。系统架构复杂。

党建系统服务于所有党员，用户量非常大，光是浙能就有7000多名党员。因此对性能要求敏感。

各个省属企业他们采购的数据库不同，有的用了达梦，有的采购了人大金仓。并且操作系统/芯片可能也各有不同。适配工作量大。

遇到问题：
- 同一个业务，是否需要对不同的数据库写不同的版本？
- 各个系统之间的兼容性问题需要大量测试和调整。
- 跨平台的数据交互会不会出现数据不一致的情况
怎么解决：
- 只写基本的sql语句，复杂的业务在应用程序解决，确保同时符合mysql/pgsql的语法
- 只能通过增加劳动力
- 制定统一的技术规范或者接口规范
什么影响：
- 稳定性肯定不如从前
- 效率也低一点
- 难以管理

# 方案制定
针对不同的操作系统/cpu，我们的解决方法是使用docker。这种容器化部署的理念就是为了在不同操作系统/cpu上运行同一个程序而无需重写代码，大大降低了适配的工作量。

数据库的适配会稍微麻烦一些。我们也询问了厂家或者别的公司，都没有什么捷径可以一步到位。特别是达梦、人大金仓这种以pgsql为基础的数据库和mysql在底层设计上有差距，只能一条一条地修改。

今年在科信部和数科公司的帮助下，我们也是邀请到了各个数据库厂家来，包括达梦，人大金仓，腾讯的tdsql，南通，阿里的PolarDB。针对其中的部分厂家，我们也做了数据迁移测试和系统的兼容性测试。

- 测试工作量大：
	涉及SQL语句改造共计2000条
	共计280个表结构改造
	共计110个视图、函数改造
	功能点描述和数量(组织建设、队伍建设、组织生活、数据填报、等共400个)
- 数据迁移敏感
	数据量超千万级，且更迭频率较快，难以实现正式环境迁移后的停机全库比对。
	包含个人信息、会议记录等手动录入的信息，万一丢失影响较大且难以恢复。
- 并轨运行
	使用同一套系统连接数据库，但市面上没有成熟的跨数据库热对比产品，自己开发成本较高，效果得不到保证。如果采用两套系统，则会增加用户的工作量，并且在后续做合并时会出现取舍的困境。


遇到问题：
- 数据库底层差异很大，需要的适配工作量很大
- 在迁移时需要考虑数据丢失或者不一致的情况
- 兼容性测试无法实现100%覆盖
怎么解决：
 - 和数据库厂商合作，针对问题做定制化或者获得原厂支持
 - 新老系统平行运行，严格的迁移测试
什么影响：
- 市场上成熟的解决方案较少，厂商优化需要等待

# 产品选型
主要考虑因素
- 适配性
- 性能
- 价格

cpu和操作系统的选择(统信和麒麟操作系统)
- 性能差异不大
- 统信的页面稍微好一点，麒麟的ui会出现一点偏差
- X86的适配性比arm的要好。

根据什么选的tdsql
- mysql适配度高(比起达梦和人大金仓)
- 价格合适(比起PolarDB)


遇到问题：
- 测试有限，无法确信找到的是最优解
怎么解决：
- 配合数科信创实验室做更严谨的测试
什么影响：
- 
# 实施改造
主要涉及以下几个层面的改造
- cpu/操作系统
- 数据迁移
- 应用代码
- 第三方应用/平台
## cpu/操作系统
(已经测试完成) cpu/操作系统，使用搭载java的不同架构(X86/arm)linux内核去构建应用的镜像。
(已经测试完成) 下载不同架构的中间件镜像(nginx, redis)。

## 数据迁移
(已经测试完成) 完成了TDSql、人大金仓、达梦的数据迁移。人大金仓和达梦迁移时兼容性问题较多，TDSql只存在一个编码问题，且比较好解决。

## 代码层面
改造主要分为这么几步
- sql代码的改造
	- 找出不适配的sql语句并修改，对代码中所有SQL语句做排查、优化和替换。
	- (已经测试完成) 系统在TDSql下运行良好，尚未发现不兼容的代码
- 第三方组件的改造
	- 包括统一身份认证，手机APP短信通知，在线预览等功能
- 操作系统层级的改造
	- shell的改造
- 数据库改造
	- 参数调优
遇到问题：
怎么解决：
什么影响：
# 测试验证
- 性能测试：同等硬件资源下，达梦、人大金仓数据库的响应速度不如mysql
- 业务测试：边做实施改造边测试
- 安全测试：
- 上线切割测试：
遇到问题：
- 目前新创产品技术与国际先进水平仍有差距，CPU架构、操作系统和数据库等基础技术仍非完全自主产权，可能存在未知的技术漏洞。
- 没有充足的时间进行测试，后续系统可能存在稳定性，安全性问题。
怎么解决：
- 与厂商跟进，保持更新
- 持续优化项目，增加应急响应储备。
什么影响：


# 并轨运行思路
是否可以修改应用程序，拦截sql语句往不通数据库发送，或者在网关把同一接口同时分发到连接了不通数据库的后台。然后定期比较两个数据库的数据是否相同，人大金仓有数据库比较的软件(要收费)；tdsql可以备份下来后用navicat做比较，达梦和人大说不定也可以，没有实际操作过。权重的改变是：mysql主-信创从 --> 信创主-mysql从 --> 信创单独运行